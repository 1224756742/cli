<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Decentraland linker</title>
    <script type="text/javascript">#web3#</script>
    <script type="text/javascript">
    var web3js, landInstance;
    function buildInstance(abi, address){
      const Contract = web3js.eth.contract(abi);
      return Contract.at(address)
    }
      window.addEventListener('load', function() {
        document.getElementById('code').innerHTML = "<h2>You are going to push theses datas to your lands:</h2><br>"+'#_data#'

        // Checking if Web3 has been injected by the browser (Mist/MetaMask)
        if (typeof web3 !== 'undefined') {
          // Use Mist/MetaMask's provider
          web3js = new Web3(web3.currentProvider);
        } else {
          //document.getElementById('body').innerHTML = "<h2>Please use a browser with Metamask extension</h2>"
          console.log('No web3? You should consider trying MetaMask!')
          // fallback - use your fallback strategy (local node / hosted node + in-dapp id mgmt / fail)
          web3js = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
        }

        landInstance = this.buildInstance(
          [{"constant":true,"inputs":[{"name":"x","type":"int256"},{"name":"y","type":"int256"}],"name":"ownerOfLand","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"x","type":"int256[]"},{"name":"y","type":"int256[]"}],"name":"ownerOfLandMany","outputs":[{"name":"","type":"address[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"x","type":"int256[]"},{"name":"y","type":"int256[]"},{"name":"data","type":"string"}],"name":"updateManyLandData","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"x","type":"int256"},{"name":"y","type":"int256"}],"name":"landData","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"x","type":"int256[]"},{"name":"y","type":"int256[]"}],"name":"clearLand","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"x","type":"int256"},{"name":"y","type":"int256"},{"name":"data","type":"string"}],"name":"updateLandData","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"}]
          , "0x9519216b1d15a91e71e8cfa17cc45bcc7707e500"
        )
      })

        function sendPush(){
          pushData(#x#, #y#, #_data#)
        }

        function pushData(x, y, _data) {
          web3js.personal.unlockAccount(
            web3js.eth.accounts[0],
            'password', (a,b,c)=>{
              console.log(a)
              console.log("Account unlocked")
              console.log("update");
              landInstance.updateLandData(x, y , JSON.stringify(_data), {
                gas: 2200000,
                price:1,
                from: web3js.eth.accounts[0]
              }, (err,res)=>{
                if(!err){
                  console.log("TX sent");
                  document.getElementById('result').innerHTML = 'TX Hash: '+res+"<br><a href='https://ropsten.etherscan.io/tx/"+res+"'/>"
                }
                else {console.log(err);}
              })
            }
          )
    }

    </script>
  </head>
  <body id="body">
    <h1>Update land metadata</h1>
    <div id="code"></div>
    <div id="status"></div>
    <div id='create'>
        <button type="button" onClick="sendPush();">push to contract</button>
    </div>
    <div id='call' style='visibility: hidden;'>
        <input type="number" id="value" onkeyup='sendPush()'></input>
    </div>
    <div id="result"></div>
  </body>
</html>
